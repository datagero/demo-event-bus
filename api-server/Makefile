# Makefile for Demo Event Bus API Server

.PHONY: test test-verbose test-coverage test-race test-unit test-integration build clean lint help

# Default target
help:
	@echo "Available targets:"
	@echo "  test          - Run all tests"
	@echo "  test-verbose  - Run tests with verbose output"
	@echo "  test-coverage - Run tests with coverage report"
	@echo "  test-race     - Run tests with race detection"
	@echo "  test-unit     - Run only unit tests"
	@echo "  test-handlers - Run only handler tests"
	@echo "  build         - Build the API server"
	@echo "  clean         - Clean build artifacts"
	@echo "  lint          - Run linter"
	@echo "  run           - Run the API server"
	@echo "  deps          - Download dependencies"

# Test targets
test:
	@echo "ğŸ§ª Running all tests..."
	go test ./...

test-verbose:
	@echo "ğŸ§ª Running tests with verbose output..."
	go test -v ./...

test-coverage:
	@echo "ğŸ§ª Running tests with coverage..."
	go test -cover ./...
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "ğŸ“Š Coverage report generated: coverage.html"

test-race:
	@echo "ğŸ§ª Running tests with race detection..."
	go test -race ./...

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	go test -run "^Test" ./internal/...

test-handlers:
	@echo "ğŸ§ª Running handler tests..."
	go test -v ./internal/api/handlers/

test-rabbitmq:
	@echo "ğŸ§ª Running RabbitMQ handler tests..."
	go test -v -run "TestRabbitMQ" ./internal/api/handlers/

test-messages:
	@echo "ğŸ§ª Running message handler tests..."
	go test -v -run "TestMessage" ./internal/api/handlers/

# Build targets
build:
	@echo "ğŸ—ï¸ Building API server..."
	go build -o api-server-test .

build-production:
	@echo "ğŸ—ï¸ Building production API server..."
	CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o api-server .

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -f api-server api-server-test coverage.out coverage.html

# Development targets
run:
	@echo "ğŸš€ Running API server..."
	go run main.go

run-test:
	@echo "ğŸš€ Running test API server..."
	./api-server-test

deps:
	@echo "ğŸ“¦ Downloading dependencies..."
	go mod download
	go mod tidy

# Linting
lint:
	@echo "ğŸ” Running linter..."
	golangci-lint run

# Docker targets (if needed)
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t demo-event-bus-api .

# Integration test targets (for when services are running)
test-integration:
	@echo "ğŸ§ª Running integration tests..."
	@echo "âš ï¸  Make sure RabbitMQ and Workers service are running"
	go test -tags=integration ./tests/integration/

# Test with isolated environment (separate ports)
test-isolated:
	@echo "ğŸ§ª Running tests with isolated environment..."
	@echo "ğŸ“¡ Tests will use ports 9001 (API) and 8002 (Workers) to avoid conflicts"
	go test -v ./internal/api/handlers/

test-recruitment:
	@echo "ğŸ§ª Testing recruitment functionality specifically..."
	go test -v -run "TestPlayerEndpoints" ./internal/api/handlers/

# Quick issue diagnosis
diagnose:
	@echo "ğŸ” Running quick diagnosis..."
	@../debug-helpers.sh full-check

# Test just the route contracts
test-contracts:
	@echo "ğŸ”— Testing frontend-backend route contracts..."
	@../debug-helpers.sh contracts
	@../debug-helpers.sh routes

# Fast feedback loop for development
dev-check:
	@echo "âš¡ Fast development check..."
	@../debug-helpers.sh health
	@echo ""
	@echo "ğŸ§ª Quick tests:"
	go test -run "TestHealthEndpoint|TestPlayerEndpoints/.*CompatibilityRoute" ./internal/api/handlers/ -v

# Benchmark tests
benchmark:
	@echo "ğŸ“ˆ Running benchmarks..."
	go test -bench=. ./...

# Test specific endpoints
test-health:
	@echo "ğŸ§ª Testing health endpoint..."
	go test -v -run "TestHealthEndpoint" ./internal/api/handlers/

test-game:
	@echo "ğŸ§ª Testing game endpoints..."
	go test -v -run "TestGameState\|TestPlayer" ./internal/api/handlers/

test-chaos:
	@echo "ğŸ§ª Testing chaos endpoints..."
	go test -v -run "TestChaos" ./internal/api/handlers/

test-dlq:
	@echo "ğŸ§ª Testing DLQ endpoints..."
	go test -v -run "TestDLQ" ./internal/api/handlers/

test-scenarios:
	@echo "ğŸ§ª Testing scenario endpoints..."
	go test -v -run "TestScenario" ./internal/api/handlers/

# Performance testing
test-load:
	@echo "ğŸ“ˆ Running load tests..."
	@echo "âš ï¸  This requires 'hey' tool: go install github.com/rakyll/hey@latest"
	hey -n 1000 -c 10 http://localhost:9000/health

# Watch tests (requires entr: brew install entr)
test-watch:
	@echo "ğŸ‘€ Watching for changes and running tests..."
	find . -name "*.go" | entr -c make test

# Generate test mocks (if using mockery)
generate-mocks:
	@echo "ğŸ¤– Generating mocks..."
	mockery --all --output ./internal/mocks

# Setup development environment
setup-dev:
	@echo "âš™ï¸ Setting up development environment..."
	go mod download
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/rakyll/hey@latest
	@echo "âœ… Development environment ready!"

# Run all checks (for CI)
ci: deps lint test test-race
	@echo "âœ… All CI checks passed!"